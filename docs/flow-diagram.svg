<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="720" viewBox="0 0 1200 720">
  <style>
    .box { fill:#ffffff; stroke:#cbd5e1; stroke-width:2; rx:12; ry:12; }
    .box-fe { fill:#f8fbff; stroke:#dbeafe; }
    .box-api { fill:#fff7ed; stroke:#fcd34d; }
    .box-oll { fill:#eef2ff; stroke:#bfdbfe; }
    .box-ui { fill:#f0fdf4; stroke:#bbf7d0; }
    .title { font: 700 18px/1.2 'Inter', Arial, sans-serif; fill:#0f172a }
    .label { font: 400 14px/1.2 'Inter', Arial, sans-serif; fill:#0f172a }
    .small { font: 400 12px/1.2 'Inter', Arial, sans-serif; fill:#475569 }
    .arrow { stroke:#94a3b8; stroke-width:2; fill:none; marker-end: url(#arrowhead); }
  </style>

  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="8" refX="10" refY="4" orient="auto">
      <path d="M0,0 L10,4 L0,8 z" fill="#94a3b8" />
    </marker>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="6" stdDeviation="12" flood-color="#0f172a" flood-opacity="0.06"/>
    </filter>
  </defs>

  <!-- Title -->
  <text x="40" y="36" class="title">TAP Project — Request flow</text>
  <text x="40" y="58" class="small">User journey: type prompt → API (system instruction) → Ollama model → sanitized response → UI render</text>

  <!-- Frontend box -->
  <rect x="60" y="100" width="260" height="120" class="box box-fe" filter="url(#shadow)"/>
  <text x="80" y="132" class="label">Frontend (UI)</text>
  <text x="80" y="154" class="small">React + Vite</text>
  <text x="80" y="172" class="small">Sends POST /ai-service/:route</text>

  <!-- API box -->
  <rect x="420" y="70" width="360" height="200" class="box box-api" filter="url(#shadow)"/>
  <text x="440" y="96" class="label">Backend API (Express)</text>
  <text x="440" y="118" class="small">- Prepend SYSTEM_INSTRUCTION</text>
  <text x="440" y="136" class="small">- callOllama()</text>
  <text x="440" y="154" class="small">- Convert Markdown → HTML (marked)</text>
  <text x="440" y="172" class="small">- Sanitize (sanitize-html)</text>

  <!-- Ollama box -->
  <rect x="820" y="100" width="320" height="120" class="box box-oll" filter="url(#shadow)"/>
  <text x="840" y="132" class="label">Ollama Server</text>
  <text x="840" y="154" class="small">Models stored in container</text>
  <text x="840" y="172" class="small">API: /api/generate, /api/tags, /api/pull</text>

  <!-- UI render box -->
  <rect x="420" y="320" width="360" height="120" class="box box-ui" filter="url(#shadow)"/>
  <text x="440" y="350" class="label">UI Render</text>
  <text x="440" y="372" class="small">Receives sanitized HTML</text>
  <text x="440" y="392" class="small">Renders assistant message (dangerouslySetInnerHTML)</text>

  <!-- arrows: FE -> API -->
  <!-- Frontend -> API (clean straight line with label above) -->
  <path class="arrow" d="M320,160 L420,160" />
  <text x="320" y="140" class="small">POST /ai-service/:route</text>

  <!-- API -> Ollama (straight with label above and moved left so it doesn't sit on top of boxes) -->
  <path class="arrow" d="M780,140 L820,140" />
  <text x="720" y="120" class="small">callOllama(model, prompt)</text>

  <!-- Ollama -> API (Ollama streams response back to the Backend API) -->
  <path class="arrow" d="M820,220 L780,220" />
  <text x="760" y="210" class="small">stream / full response → API</text>

  <!-- API -> UI render (Backend returns sanitized HTML or streams tokens to the UI) -->
  <path class="arrow" d="M600,270 L600,320" />
  <text x="610" y="294" class="small">Return JSON / stream → UI (sanitized)</text>

  <!-- Legend / notes -->
  <rect x="60" y="480" width="1040" height="200" rx="10" ry="10" fill="#ffffff" stroke="#e6eef7"/>
  <text x="80" y="512" class="label">Legend &amp; important parts</text>
  <text x="80" y="536" class="small">Frontend: React UI (Vite) — user input, selection, rendering.</text>
  <text x="80" y="556" class="small">Backend: Express — system instruction prepend, markdown → HTML conversion, sanitization, routing.</text>
  <text x="80" y="576" class="small">Ollama: model serving — stores models, generates tokens; accessed via HTTP in container.</text>
  <text x="80" y="596" class="small">Docker Compose: orchestrates services, shared network, model persistence volume.</text>

  <!-- footer -->
  <text x="40" y="700" class="small">Generated diagram — saved as docs/flow-diagram.svg</text>
</svg>
